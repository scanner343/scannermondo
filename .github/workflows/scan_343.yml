name: Scan Mondo 343 (RE-IT-7)

on:
  schedule:
    - cron: '15 */4 * * *' # Esegue ogni 4 ore al minuto 15
  workflow_dispatch:       # Esecuzione manuale

jobs:
  scan_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Codice Scanner
        uses: actions/checkout@v4

      - name: Setup PHP e Node
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
      
      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 1. CLONA DATABASE RE-PANZA (Per avere lo storico)
      - name: Clone Database Repo
        env:
          MY_PAT: ${{ secrets.PAT_GITHUB }} 
        run: |
          # Clona la repo dove tieni i JSON
          git clone https://x-access-token:${MY_PAT}@github.com/Re-Panza/lk_database.git db_repo
          
          # Copia il DB esistente nella cartella di lavoro corrente
          cp db_repo/database_mondo_343.json . || echo "[]" > database_mondo_343.json

      # 2. ESEGUI SCANNER PHP (Usa il nuovo cURL)
      - name: Run PHP Scanner
        run: php scanner_343.php

      # 3. ELABORA INATTIVITÃ€ CON NODE
      - name: Update History
        run: node update_history_343.js

      # 4. PUSHA I RISULTATI SU RE-PANZA
      - name: Push to Re-Panza Database
        env:
          MY_PAT: ${{ secrets.PAT_GITHUB }}
        run: |
          cd db_repo
          git config --global user.name "Re Panza Bot"
          git config --global user.email "bot@repanza.it"
          
          # Sovrascrivi il file nella cartella della repo con i nuovi dati
          cp ../database_mondo_343.json .
          
          # Committa e Pusha
          git add database_mondo_343.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Update 343: $(date)" && git push)
